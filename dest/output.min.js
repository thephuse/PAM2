var app=app||{};app.User=Backbone.Model.extend({defaults:{name:"",department:"",isActive:!1}});var app=app||{};app.Entry=Backbone.Model.extend({});var app=app||{},UserList=Backbone.Collection.extend({model:app.User,url:"/users",parse:function(t){var e=[];return $(t).find("user").each(function(){var t=$(this).find("first-name").text(),s=$(this).find("is-active").text(),a=$(this).find("id").text(),i=$(this).find("department").text(),r=$(this).find("email").text();e.push({id:a,name:t,active:s,department:i,email:r})}),e},fetch:function(t){t=t||{},t.dataType="xml",Backbone.Collection.prototype.fetch.call(this,t)}});app.Users=new UserList;var app=app||{},EntryList=Backbone.Collection.extend({model:app.Entry,parse:function(t){var e=[];return $(t).find("day-entry").each(function(){var t=$(this).find("hours").text();e.push({hours:t})}),e},fetch:function(t){t=t||{},t.dataType="xml",Backbone.Collection.prototype.fetch.call(this,t)}}),app=app||{};app.AppView=Backbone.View.extend({el:"body",range:"week",statsTemplate:_.template($("#stats-template").html()),events:{"click .filter":"filterRange"},initialize:function(){app.Users.fetch({reset:!0}),this.listenTo(app.Users,"reset",this.render),this.listenTo(app.Users,"change",this.showStats),this.getEnd(),setInterval(function(){app.Users.fetch({reset:!0})},6e4)},render:function(){this.$("#users").find("tbody").html(""),app.Users.each(this.showActive,this)},showActive:function(t){var e=this.getEnd(),s=this.getStart(this.range);if("true"===t.get("active")){var a=new app.UserView({model:t,endDate:e,startDate:s});$("#users").append(a.render().el)}},showStats:function(){var t=0,e=0;app.Users.each(function(s){if("true"===s.get("active")){var a=s.get("hours"),i=s.get("billableHours");t+=parseFloat(a),e+=parseFloat(i)}});var s=(100*(e/t)).toFixed(1);this.$("#footer tbody").html(this.statsTemplate({hours:isNaN(t)?"0.0":t.toFixed(1),billableHours:isNaN(e)?"0.0":e.toFixed(1),percentBillable:isNaN(s)?"0.0":s}))},getEnd:function(){return moment().format("YYYYMMDD")},filterRange:function(t){this.range=$(t.currentTarget).data("range"),this.$("li").removeClass("active"),$(t.currentTarget).parent("li").addClass("active"),this.render()},getStart:function(t){switch(t){case"day":return moment().format("YYYYMMDD");case"month":return moment().startOf("month").format("YYYYMMDD");case"week":return moment().startOf("week").add("days",1).format("YYYYMMDD");default:return moment().startOf("week").add("days",1).format("YYYYMMDD")}}});var app=app||{};app.UserView=Backbone.View.extend({tagName:"tr",template:_.template($("#person-template").html()),initialize:function(t){var e=this;this.end=t.endDate,this.start=t.startDate;var s=new $.Deferred,a=new $.Deferred;this.getTotalHours(s),this.getBillableHours(a),this.getStatus(),$.when(s,a).then(function(){e.calcPercent()})},getTotalHours:function(t){var e=this,s=new EntryList({});s.url="/users/"+this.model.get("id")+"/"+this.start+"/"+this.end,s.fetch({success:function(){var a=0;s.each(function(t){a+=parseFloat(t.get("hours"))}),a=a.toFixed(2),e.model.set({hours:a}),e.$el.find("#hours").html(e.model.get("hours")),t.resolve()}})},getBillableHours:function(t){var e=this,s=new EntryList({});s.url="/users/"+this.model.get("id")+"/billable/"+this.start+"/"+this.end,s.fetch({success:function(){var a=0;s.each(function(t){a+=parseFloat(t.get("hours"))}),a=a.toFixed(2),e.model.set({billableHours:a}),e.$el.find("#billable").html(e.model.get("billableHours")),t.resolve()}})},calcPercent:function(){var t=this.model.get("hours"),e=this.model.get("billableHours"),s=100*(e/t);t>0&&this.$el.find("#percent").html(s.toFixed(0))},getStatus:function(){var t=this.model.get("id"),e=this;$.get("/daily/"+t,function(t){$(t).find("timer_started_at").length>0?(e.model.set({isActive:!0}),e.$el.find(".status").addClass("status-true"),e.$el.find(".status").removeClass("status-false")):(e.model.set({isActive:!1}),e.$el.find(".status").addClass("status-false"),e.$el.find(".status").removeClass("status-true"))})},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}});