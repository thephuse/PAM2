<html>
<head>
  <title>NODE BITCHES</title>

</head>
<body>

  <a href="#" id="filter-day">Day</a>
  <a href="#" id="filter-week">Week</a>
  <a href="#" id="filter-month">Month</a>

  <ul id="users">
    
  <script type="text/template" id="person-template">
    <li class="person">
      <%- id %> | <strong><%- name %></strong> <%- department%> | <strong id="hours">0.0</strong>
    </li>
  </script>
  </ul>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://documentcloud.github.io/underscore/underscore-min.js" type="text/javascript"></script>
  <script src="http://documentcloud.github.io/backbone/backbone-min.js" type="text/javascript"></script>
  <script>

  Date.prototype.yyyymmdd = function() {
   var yyyy = this.getFullYear().toString();
   var mm = (this.getMonth()+1).toString(); // getMonth() is zero-based
   var dd  = this.getDate().toString();
   return yyyy + (mm[1]?mm:"0"+mm[0]) + (dd[1]?dd:"0"+dd[0]); // padding
  };

  var app = app || {}; 

  app.User = Backbone.Model.extend ({
    defaults: {
      name: '',
      department: ''
    }
  });

  app.Entry = Backbone.Model.extend ({});

  var UserList = Backbone.Collection.extend ({
    model: app.User,
    url: '/users',
    parse: function (data) {
        var parsed = [];
        $(data).find('user').each(function (index) {
            var fname = $(this).find('first-name').text();
            var isActive = $(this).find('is-active').text();
            var uid = $(this).find('id').text();
            var dept = $(this).find('department').text();
            parsed.push({id: uid, name: fname, active: isActive, department: dept});
        })
        return parsed;
      },
      fetch: function (options) {
        options = options || {};
        options.dataType = "xml";
        Backbone.Collection.prototype.fetch.call(this, options);
      }    
  });

  var EntryList = Backbone.Collection.extend ({
    model: app.Entry,
    parse: function (data) {
        var parsed = [];
        $(data).find('day-entry').each(function (index) {
            var hours = $(this).find("hours").text();           
            parsed.push({hours: hours});
        })
        return parsed;
      },
      fetch: function (options) {
        options = options || {};
        options.dataType = "xml";
        Backbone.Collection.prototype.fetch.call(this, options);
      }    
  });

  app.Users = new UserList(); 

  app.AppView = Backbone.View.extend ({
    el: 'body',
    initialize: function() {
      app.Users.fetch({reset: true});
      this.listenTo(app.Users, 'reset', this.render);  
      this.getDate();
    },
    render: function() {
      this.$("#users").html('');
      app.Users.each(this.showActive, this);
    },
    showActive: function(user) {
      if (user.get("active") === "true") {
        var view = new app.UserView({model: user});
        $("#users").append(view.render().el);
      }
    },
    getDate: function() {
      var d = new Date();
      return d.yyyymmdd();
    }
  });

  app.UserView = Backbone.View.extend ({
    tagname: 'li',
    template: _.template($('#person-template').html()),    
    initialize: function() {      
      var self = this;
      var Entries = new EntryList({});
      Entries.url = '/users/' + this.model.get("id") + "/20130101/20130201";
      Entries.fetch(
        {success: function(){
          var totalHours = 0;
          Entries.each(function(entry){
            totalHours += parseFloat(entry.get("hours"));
          });
          totalHours = totalHours.toFixed(2);
          self.model.set({hours: totalHours});
          self.$el.find("#hours").html(self.model.get("hours"));
        }
      });     
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    }
  });

  $(document).ready(function(){
    new app.AppView();
  });

  </script>
</body>
</html>